# 项目完成度与完善计划

## 完成度评估
- 架构与页面：Jetpack Compose+Navigation 的页面与导航齐备，结构清晰（高）
- Supabase 接入：配置与 REST 客户端可用，已实现登录与两张表只读查询（中）
- 鉴权与会话：仅内存保存 token，缺乏安全持久化、刷新与重启恢复（低-中）。参考：`app/src/main/java/com/example/healthapp/data/remote/AuthApi.kt:28`、`app/src/main/java/com/example/healthapp/data/SessionManager.kt:4`
- 数据层打通：除 `heart_rates`、`steps` 读取外，多数业务仍为 Mock，未落库写入（低）。参考：`app/src/main/java/com/example/healthapp/data/remote/PostgrestApi.kt:22`、`app/src/main/java/com/example/healthapp/data/remote/PostgrestApi.kt:33`
- 导入功能：解析与预览完成，缺少上传 Supabase 与记录状态管理（低）
- RPC/Edge Functions：未实现（低）

## 未完成任务清单（前端/后端/数据库）
- 前端
  - 会话持久化与启动自动恢复
  - 登录/注册错误提示与国际化
  - 导入流程的落库与反馈（含进度/失败重试）
  - 对接 `sleep_sessions`、`meals`、`water_intakes`、`moods`、`exercise_sessions` 的 CRUD
  - 统一网络错误处理与重试策略
- 后端（基于 Supabase）
  - 引入 refresh_token 与会话生命周期管理
  - 批量导入与汇总统计的 Edge Functions（Deno）
  - Postgres RPC/SQL 函数：批量 upsert、统计聚合、导入审计
  - RLS 策略审核与必要的策略补充（仅允许 `auth.uid()` 访问自身数据）
- 数据库
  - 表约束与索引：主键/外键、唯一约束、时间/用户索引
  - 迁移与环境：本地/测试/生产迁移脚本与发布流程
  - 导入审计表与状态字段：记录来源、文件名、行数、状态、错误原因

## 前端完善计划
1. 会话持久化与恢复
- 使用 `EncryptedSharedPreferences` 或 `DataStore` 安全存储 `access_token`/`refresh_token`
- App 启动读取并校验 token，驱动 `AuthViewModel.isLoggedIn`；路由守卫置入统一入口
- 添加退出登录流程，清理本地会话
2. 鉴权与错误提示
- 将 `IllegalStateException(bodyText)` 改为统一错误模型；区分 401/403/422 并呈现可读文案
- 支持多语言文案（strings.xml），登录/注册/导入等关键流程覆盖
3. 导入落库与反馈
- 解析后调用后端 RPC/Edge Function 批量写入；本地显示导入进度与结果
- 失败重试、部分失败可导出错误报告
4. 业务页面数据打通
- 为 `sleep_sessions`、`meals`、`water_intakes`、`moods`、`exercise_sessions` 实现读取与写入（表单校验+提交）
- 列表+详情页的分页与刷新；图表组件复用统一数据适配器
5. 网络层与稳定性
- 在 `Ktor` 层加入重试、超时、统一 Header（`apikey`+`Authorization`）
- 统一 JSON 序列化配置与日期格式；引入轻量日志与埋点

## 后端完善计划（Supabase）
1. 鉴权与会话
- 使用 Supabase Auth 的 `refresh_token`，在客户端刷新 `access_token`
- 如采用服务器中转，提供简易 token 交换/校验端点（可选）
2. Edge Functions
- `import_bulk`：接收 CSV/JSON，服务端解析并批量 upsert 到各业务表；写入导入审计表
- `metrics_summary`：返回心率、步数、睡眠等聚合统计，减少多次查询
3. RPC/SQL 函数
- `fn_upsert_sleep/meals/water/moods/exercise`：保证幂等写入
- `fn_import_log_update(status, errors)`：导入状态机管理
4. RLS 与安全
- 审核各表策略，确保 `user_id = auth.uid()`；写操作策略区分 insert/update/delete
- 为审计表开放只读查询策略与仅本人访问限制

## 数据库完善计划
1. 约束与索引
- 为业务表添加主键/唯一约束（防重复），外键约束（用户绑定）
- 为 `user_id`、`at/created_at` 建立索引，优化查询
2. 审计与导入表
- 设计 `imports`/`import_items`：来源、文件名、行数、状态（pending/running/success/failed）、错误详情
- 与 Edge Function/RPC 协同更新状态
3. 迁移与环境
- 完善 `supabase/schema.sql` 并拆分为迁移；制定本地→测试→生产发布流程
- 在仓库添加环境示例与文档（不含密钥），规范 `local.properties` 注入。参考：`app/build.gradle:33-34`

## 里程碑与验收标准
- M1（鉴权/会话）
  - 启动自动恢复登录；token 安全存储与刷新；退出登录可用
  - 验收：重启后仍处于登录态；401 自动刷新成功
- M2（导入与写入）
  - 导入 CSV/JSON 并批量落库；导入状态可视；错误可重试
  - 验收：导入 1k+ 记录耗时可接受，审计表记录完整
- M3（多表数据打通）
  - 5 个业务表的读写与页面完成；图表与列表联动
  - 验收：CRUD 全覆盖，RLS 生效
- M4（稳定性与错误处理）
  - 统一错误模型与国际化；网络重试与日志
  - 验收：关键流程有明确提示，错误码映射正确

## 风险与保障
- 密钥与配置：`SUPABASE_ANON_KEY` 仅用于客户端；避免构建产物泄露；按环境注入
- RLS/写入风险：所有写入走 RPC/Edge Function 并校验 `user_id`
- 性能与费用：批量导入使用服务器端解析与 upsert，降低 PostgREST 压力

——以上为基于现状的完成度分析与任务清单/完善方案，确认后我将分阶段落地具体实现。