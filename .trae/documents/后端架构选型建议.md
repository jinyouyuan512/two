# 后端架构选型建议

## 目标与范围
- 支持移动端健康应用的数据采集、统计分析、AI 助手对话、用户账户与设置。
- 优先满足：稳定性、可观测性、合规与隐私、安全、后续扩展到微服务。

## 推荐技术栈方案

### 方案 A：Kotlin + Spring Boot 3（推荐）
- 适用场景：Android 团队、Java/Kotlin 生态熟悉；需要强类型与成熟中间件支持。
- 组件：Spring Web MVC/Security、JPA(Hibernate) 或 MyBatis、Spring Data Redis、Spring Cloud（后续微服务）。
- 数据库：PostgreSQL；缓存：Redis；对象存储：S3/OSS；消息队列：Kafka/RabbitMQ。
- 优点：生态成熟、工程化完善、易做合规与审计；对复杂业务与批处理支持好。
- 风险：初始资源占用相对高；开发门槛较 NestJS 高。

### 方案 B：Node.js + NestJS（推荐）
- 适用场景：前后端同构；快速迭代；需要灵活编排与流式处理（SSE/WebSocket）。
- 组件：NestJS(HTTP/SSE、Guards)、TypeORM/Prisma、Redis、BullMQ、Swagger。
- 优点：开发效率高、SSE/实时能力好、类型驱动（TypeScript）；对轻量服务与 BFF 合适。
- 风险：CPU 密集场景需谨慎；对大型复杂批处理略弱。

### 方案 C：Go + Fiber/Gin（备选）
- 优点：高性能、低资源占用；适合同步器/数据管道与微服务段。
- 风险：生态在业务层次（ORM、权限）需要更多自研封装。

### 方案 D：Python + FastAPI（备选）
- 优点：AI/数据分析生态强；编写算法/分析型子服务友好。
- 风险：高并发需协程与基础设施配合；类型系统相对弱。

## 领域模块与接口

- 用户与设置
  - GET `/v1/users/me`、PATCH `/v1/users/me`
  - GET/PATCH `/v1/settings`
- 首页与建议
  - GET `/v1/home/overview` 今日概况与趋势
  - GET `/v1/home/suggestions` AI 健康建议
- 数据中心（心率/步数/体重等）
  - GET `/v1/data/heart-rate?date=YYYY-MM-DD`
  - GET `/v1/data/steps?date=YYYY-MM-DD`
  - GET `/v1/data/weight?from=...&to=...`
  - GET `/v1/data/records?cursor=...&limit=20`
- 健康聚合（运动/营养/睡眠/情绪）
  - 运动：GET `/v1/exercise/plans`、POST `/v1/exercise/sessions`、GET `/v1/exercise/stats?range=week`
  - 营养：GET/POST `/v1/nutrition/records`、GET `/v1/nutrition/analysis?date=...`
  - 睡眠：GET `/v1/sleep/overview?date=...`、GET `/v1/sleep/weekly`
  - 情绪：GET/POST `/v1/mood/entries`、GET `/v1/mood/weekly-trend`
- AI 助手（SSE）
  - POST `/v1/ai/chat` 返回 `text/event-stream` 流式响应
  - GET `/v1/ai/quick-questions`

## 数据模型（PostgreSQL）

- users(id, phone/email, hashed_password, created_at)
- profiles(user_id, name, avatar_url, age, gender, height, weight)
- settings(user_id, push_enabled, auto_sync, data_share)
- heart_rate(user_id, timestamp, bpm, source)
- steps(user_id, date, count, source)
- sleep_records(user_id, start_at, end_at, quality, stages_json)
- weight(user_id, timestamp, kg, source)
- nutrition_records(user_id, timestamp, meal_type, calories, macros_json)
- mood_entries(user_id, timestamp, mood, score, note)
- ai_messages(id, user_id, role, content, created_at, conversation_id)
- ai_quick_questions(id, category, icon, question, enabled)
- 索引：`(user_id, timestamp)`/`(user_id, date)`；冷热分层（90 天内在线，历史归档）。

## 安全与合规

- 认证：JWT（Access 15m、Refresh 7d）；密码加密（Argon2/Bcrypt）。
- 授权：基于用户资源隔离；管理端角色 `admin`。
- 传输：全站 HTTPS；移动端附带 `device_id`；CSRF 不适用于移动 API。
- 隐私与合规：数据最小化、目的限制、访问审计；PII 分区存储；日志脱敏。
- 速率限制：`Redis` 令牌桶；敏感接口（AI、导入）限制每分请求数。

## 可观测与质量

- 日志：结构化 JSON，区分 api/integration/job；相关 ID 贯穿。
- 指标：Prometheus + Grafana（QPS、P95 延迟、错误率、队列滞留、AI 响应时延）。
- 追踪：OpenTelemetry（跨模块调用链）。
- 测试：单元（Jest/JUnit）、集成（Testcontainers）、契约测试（OpenAPI 校验）。

## 部署与 CI/CD

- 环境：`dev/staging/prod` 分层；配置走环境变量与密钥管理。
- 构建：Docker 镜像；K8s Deployment 滚动发布；蓝绿/灰度策略。
- CI：lint + 测试 + 安全扫描（Snyk/OWASP）+ 镜像构建 + 部署。

## 选型决策建议

- 若团队偏 Android/Java，业务复杂度高，选 **方案 A（Spring Boot）**。
- 若追求迭代速度与实时能力，前后端同构，选 **方案 B（NestJS）**。
- 高并发数据管道/同步器可用 **方案 C（Go）** 作为独立子服务。
- AI 分析/报表子服务可引入 **方案 D（FastAPI）**。

## 起步里程碑

1. 打基础：用户/认证/设置模块、首页概览、数据中心读接口。
2. 接入 AI：`/v1/ai/chat`（SSE）与 `quick-questions` 列表。
3. 数据同步：外设整合、增量拉取与清洗；周/月统计物化视图。
4. 可观测与安全：日志、指标、追踪、限流、审计落地。
5. 微服务化（可选）：按域拆分 + API 网关 + 统一认证。

---

如你确认某方案，我可基于该栈在仓库中落地最小可运行骨架（控制器、实体、仓库、SSE 示例），并补充 OpenAPI 契约。

